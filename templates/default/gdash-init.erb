#!/bin/sh
#
# chkconfig:	345 85 15

# Generated by Chef, will be replaced at next chef-client run!

# Source function library
. /etc/rc.d/init.d/functions

# Source networking configuration.
. /etc/sysconfig/network

# Check that networking is up.
[ "${NETWORKING}" = "no" ] && exit 0

PROJSPATH=/srv/gdash			# The folder project is in
PIDSPATH=/var/run				# Where you put .pid file
RUNAS=root					# Set a different user to run the FastCGI server

SRVNAME=gdash				# Process name

start () {
	# Check if the service is already running?
	if [ ! -f $PIDSPATH/$SRVNAME.pid ]; then
		echo -n $"Starting $SRVNAME..."
		cd $PROJSPATH
		daemonize -u $RUNAS -p $PIDSPATH/$SRVNAME.pid -- $PROJSPATH/bin/unicorn -c /etc/unicorn/gdash.app config.ru  --env <%= node.chef_environment %>
		echo
		RETVAL=$?
	else
		echo $"$SRVNAME is already running."
	fi
}

stop() {
	# Stop daemons.
	if [ -f $PIDSPATH/$SRVNAME.pid ]; then
		echo $"Stopping $SRVNAME..."
		kill -9 -`cat $PIDSPATH/$SRVNAME.pid`

		# Delete pidfile only when was called successfully
		if [ $? -eq 0 ]; then
			rm -f $PIDSPATH/$SRVNAME.pid "$SRVNAME.pid"  >/dev/null 2>&1
		fi
	else
		echo $"$SRVNAME is NOT running."
	fi

}

RETVAL=0

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	status)
		status -p "$PIDSPATH/$SRVNAME.pid" $SRVNAME
		RETVAL=$?
		;;
	restart)
		stop
		start
		;;
	*)
		echo $"Usage: $0 {start|stop|restart|status}"
		exit 3
		;;
esac

exit $RETVAL

